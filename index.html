<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Badge Gallery (Overlay Modal + Anti-Jump + Compat)</title>
<style>
:root{
  --bg:#02104f; --fg:#f2f3f5; --muted:#cdd4ff;
  --panel:#0b1247; --bd:#3a48b0; --r:12px; --gap:14px;
  --control-bg:#0d155c; --control-bg-hover:#111a70;
  --control-bd:#2a347a; --control-fg:#f2f3f5; --accent:#7c9eff;
  --modal-bg:#02104f; --modal-media-bg:#030d3b; --overlay:rgba(0,0,0,.6);
}
*{box-sizing:border-box}
body{margin:0; font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; background:var(--bg); color:var(--fg)}
.wrap{max-width:1100px; margin:0 auto; padding:16px}

/* top bar */
.toolbar{display:flex; align-items:center; gap:10px}
.search{flex:1 1 100%; min-width:0}
.search input{width:100%; padding:12px 14px; border:1px solid var(--control-bd); border-radius:12px; background:var(--control-bg); color:var(--control-fg); outline:none}
.search input:hover{background:var(--control-bg-hover)}
.search input:focus{outline:2px solid var(--accent); outline-offset:2px}
.select{margin-left:auto; flex:0 0 auto}
.select select{padding:10px 12px; border:1px solid var(--control-bd); border-radius:12px; background:var(--control-bg); color:var(--control-fg)}

/* grid */
.grid{display:grid; gap:var(--gap); grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); margin-top:16px}
.card{background:var(--panel); border:1px solid var(--bd); border-radius:var(--r); padding:8px; cursor:pointer; min-height:140px; display:flex; align-items:center; justify-content:center}
.card img{display:block; width:100%; height:auto; border-radius:calc(var(--r) - 6px)}
.card .ph{width:100%; aspect-ratio:1/1; border:1px dashed var(--bd); border-radius:calc(var(--r) - 6px); display:grid; place-items:center; color:var(--muted); font-size:12px; padding:8px; text-align:center}


/* ===== Modal (Google Sites–safe, JS centers within viewport) ===== */
#modal[hidden]{ display:none; }

/* overlay — JS will position it each time */
#modal{
  position: absolute;   /* JS sets top + height */
  left: 0;
  width: 100%;
  background: var(--overlay);
  display: block;
  z-index: 9999;
}

/* box — JS sets top/left/transform to center within visible window */
#modal .modal-wrap{
  position: absolute;
  width: min(var(--modal-w, 760px), 92vw);
  max-height: var(--modal-max-h, 88vh);
  display: grid;
  grid-template-columns: 1fr var(--modal-info-w, 300px);
  border-radius: 16px;
  overflow: hidden;
}

/* contents */
.modal-media{
  background: var(--modal-media-bg);
  display: flex; align-items: center; justify-content: center;
  padding: 16px;
}
.modal-media img{
  max-width: 100%;
  max-height: calc(var(--modal-max-h, 88vh) - 32px);
  border-radius: 12px;
}
.modal-info{
  background: var(--modal-bg);
  border-left: 1px solid var(--bd);
  padding: 12px;
  position: relative;
  padding-bottom: 56px; /* space for Prev/Next row if pinned */
}
.navbtns{
  position: absolute; right: 12px; bottom: 12px;
  display: flex; gap: 8px;
}
.close{
  position: absolute; top: 8px; right: 8px;
  background: transparent; border: none; color: var(--fg);
  font-size: 20px; cursor: pointer;
}

@media (max-width:720px){
  #modal .modal-wrap{ grid-template-columns: 1fr; }
  .modal-info{ border-left:none; border-top:1px solid var(--bd); }
}


@media (max-width:720px){
    .modal-info{border-left:none; border-top:1px solid var(--bd)}
  .modal-media img{max-height:60vh}
}

/* a11y */
.sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0}
html.is-modal-open { overflow: hidden; }

/* debug panel (can be hidden) */
#dbg{position:fixed; bottom:8px; left:8px; background:#0008; color:#fff; padding:6px 8px; border-radius:8px; font:12px/1.4 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; z-index:99999}
#dbg.hidden{display:none}




/* Center the modal box in the current viewport */
:root{
  /* easy knobs you can tweak */
  --modal-w:      760px;   /* overall modal width */
  --modal-info-w: 300px;   /* right pane width */
  --modal-max-h:  78vh;    /* height cap */
}


/* keep content inside the height cap */
.modal-media img{ max-height: calc(var(--modal-max-h) - 32px); }

/* make sure the right pane has room for buttons if you anchor them */
.modal-info{ padding-bottom: 56px; }









/* Size the modal box to the viewport, not the page height */
:root{
  --modal-w:      760px;   /* overall modal width (tweak me) */
  --modal-info-w: 300px;   /* right pane width (tweak me) */
  --modal-max-h:  88vh;    /* height cap relative to viewport */
}
@supports (height: 100dvh){
  :root{ --modal-max-h: 88dvh; } /* more reliable on mobile */
}


/* Left side (image) fills but never exceeds viewport */
.modal-media{
  background: var(--modal-media-bg);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 16px;
}
.modal-media img{
  max-width: 100%;
  max-height: calc(var(--modal-max-h) - 32px);
  width: auto;
  height: auto;
  object-fit: contain;
}

/* Right pane scrolls internally if content is long */
.modal-info{
  background: var(--modal-bg)
}





</style>
</head>
<body>
  <div class="wrap">
    <div class="toolbar" role="search">
      <div class="search">
        <label class="sr-only" for="q">Search badges</label>
        <input id="q" type="search" placeholder="Search badges…" autocomplete="off" />
      </div>
      <div class="select">
        <label class="sr-only" for="sort">Sort</label>
        <select id="sort">
          <option value="name-asc">Name ↑</option>
          <option value="name-desc">Name ↓</option>
        </select>
      </div>
    </div>

    <div class="counter"><small id="count"></small></div>
    <div id="err" class="err" role="status" aria-live="polite"></div>

    <div id="grid" class="grid" aria-live="polite"></div>
  </div>

  <div id="modal" role="dialog" aria-labelledby="modal-title" aria-modal="true" hidden>
    <div class="modal-wrap">
      <div class="modal-media">
        <img id="mimg" alt="">
      </div>
      <div class="modal-info">
        <button id="mclose" class="close" aria-label="Close">✕</button>
        <div id="modal-title" class="modal-title"></div>
        <div id="mcrit"></div>
        <div class="navbtns">
          <button id="prevBtn" aria-label="Previous">← Prev</button>
          <button id="nextBtn" aria-label="Next">Next →</button>
        </div>
      </div>
    </div>
  </div>

  <div id="dbg" class="hidden"></div>

<script>
const DATA_URL = 'badges.json';

const grid   = document.getElementById('grid');
const q      = document.getElementById('q');
const sortEl = document.getElementById('sort');
const count  = document.getElementById('count');
const errEl  = document.getElementById('err');

const modal  = document.getElementById('modal');
const mimg   = document.getElementById('mimg');
const mtitle = document.getElementById('modal-title');
const mcrit  = document.getElementById('mcrit');
const mclose = document.getElementById('mclose');
const prevBtn= document.getElementById('prevBtn');
const nextBtn= document.getElementById('nextBtn');

const dbgEl  = document.getElementById('dbg');
function dbg(msg){
  // toggle visibility by removing 'hidden' if needed
  // dbgEl.classList.remove('hidden');
  dbgEl.textContent = String(msg).slice(0, 500);
}

let BADGES = [];
let CURRENT = [];
let currentIndex = -1;

const norm = s => (s||'').toLowerCase().normalize('NFKD').replace(/[\u0300-\u036f]/g,'');

function imageFrom(b){
  return b.imageUrl ?? b.imageURL ?? b.url ?? b.image ?? b.src ?? '';
}

function apply(){
  const term = norm(q.value);
  const dir  = sortEl.value;

  CURRENT = BADGES.filter(b => {
    if (!term) return true;
    return norm(b.name).includes(term)
        || norm(b.criteria ?? '').includes(term);
  });

  CURRENT.sort((a,b)=>{
    const an = norm(a.name), bn = norm(b.name);
    return dir === 'name-desc' ? bn.localeCompare(an) : an.localeCompare(bn);
  });

  render(CURRENT);
}

function render(list){
  grid.innerHTML = '';
  const frag = document.createDocumentFragment();
  list.forEach((b,i)=>{
    const card = document.createElement('button');
    card.className = 'card';
    card.type = 'button';
    card.setAttribute('aria-label', b.name);

    // Anti-jump: prevent the default mouse/touch focus behavior
    card.addEventListener('mousedown', e => e.preventDefault());
    card.addEventListener('touchstart', e => { e.preventDefault(); }, { passive: false });

    card.addEventListener('click', ()=> openModalByIndex(i));

    const src = imageFrom(b);
    const img = document.createElement('img');
    img.loading = 'lazy';
    img.alt = b.name;
    img.src = src;
    img.referrerPolicy = 'no-referrer';
    img.onerror = ()=>{


      // Show placeholder instead of a broken image
      img.remove();
      const ph = document.createElement('div');
      ph.className = 'ph';
      ph.textContent = 'Image failed to load';
      card.appendChild(ph);
    };

    card.appendChild(img);
    frag.appendChild(card);
  });
  grid.appendChild(frag);

  // debug first item
  if (list[0]) dbg('First image src: ' + imageFrom(list[0]));
}

/* ===== Overlay modal helpers (with Google Sites fixed-position fallback) ===== */
const modalWrap = document.querySelector('#modal .modal-wrap');

function modalIsOpen(){ return !modal.hasAttribute('hidden'); }

function supportsFixedPosition(){
  const t = document.createElement('div');
  t.style.cssText = 'position:fixed;top:10px;left:0';
  document.body.appendChild(t);
  const ok = t.getBoundingClientRect().top === 10;
  t.remove();
  return ok;
}

let emulate = false;
function emulateFixedTick(){
  const y = window.scrollY || document.documentElement.scrollTop || 0;
  const h = window.innerHeight;

  // size/position the overlay to the visible viewport
  modal.style.position = 'absolute';
  modal.style.top = y + 'px';
  modal.style.left = '0';
  modal.style.height = h + 'px';
  modal.style.width  = '100%';

  // center the modal box within the visible viewport
  const mh = Math.min(modalWrap.offsetHeight || 0, h * 0.9);
  const top = y + Math.max(12, (h - mh)/2);
  modalWrap.style.position = 'absolute';
  modalWrap.style.top = Math.round(top) + 'px';
  modalWrap.style.left = '50%';
  modalWrap.style.transform = 'translateX(-50%)';
}

function enableEmulation(){
  if (emulate) return;
  emulate = true;
  emulateFixedTick();
  window.addEventListener('scroll', emulateFixedTick, { passive: true });
  window.addEventListener('resize', emulateFixedTick);
}

function disableEmulation(){
  if (!emulate) return;
  emulate = false;
  window.removeEventListener('scroll', emulateFixedTick);
  window.removeEventListener('resize', emulateFixedTick);
  // cleanup inline styles
  ['position','top','left','height','width'].forEach(k => modal.style[k] = '');
  ['position','top','left','transform'].forEach(k => modalWrap.style[k] = '');
}

function modalOpen(){
  if (!modalIsOpen()){
    modal.removeAttribute('hidden');
    document.documentElement.classList.add('is-modal-open');
    if (!supportsFixedPosition()) enableEmulation();
  }
}

function modalClose(){
  if (modalIsOpen()){
    modal.setAttribute('hidden','');
    document.documentElement.classList.remove('is-modal-open');
    disableEmulation();
  }
}

(async () => {
  const base = location.pathname.replace(/[^/]+$/, ''); // '/dnd_badges/' when hosted
  const tried = [
    'badges.json',
    base + 'badges.json' // fallback if index.html is in a subfolder
  ];

  let data = null, lastErr = null;
  for (const url of tried) {
    try {
      const r = await fetch(url, { cache: 'no-store' });
      if (!r.ok) throw new Error('HTTP ' + r.status + ' for ' + url);
      data = await r.json();
      console.log('Loaded badges from', url, 'count =', Array.isArray(data) ? data.length : 0);
      break;
    } catch (e) {
      lastErr = e;
      console.warn('Tried', url, '->', e.message);
    }
  }

  if (!Array.isArray(data) || data.length === 0) {
    const msg = lastErr
      ? `Could not load badges.json (${lastErr.message}).` 
      : `Loaded 0 items from badges.json — is it empty or misnamed?`;
    if (errEl) errEl.textContent = msg;
    return;
  }

  BADGES = data.map(b => ({
    id: b.id ?? b.slug ?? '',
    name: b.name ?? 'Untitled',
    imageUrl: (b.imageUrl ?? b.imageURL ?? b.url ?? b.image ?? b.src ?? ''),
    criteria: b.criteria ?? ''
  }));

  // Optional: show count while debugging
  if (errEl) errEl.textContent = `Loaded ${BADGES.length} badges.`;
  apply();
})();


</script>
</body>
</html>
