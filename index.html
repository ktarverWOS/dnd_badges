<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Badge Gallery — Fixed</title>
<style>
:root{
  --bg:#02104f; --fg:#f2f3f5; --muted:#cdd4ff;
  --panel:#0b1247; --bd:#3a48b0; --r:12px; --gap:14px;
  --control-bg:#0d155c; --control-bg-hover:#111a70;
  --control-bd:#2a347a; --control-fg:#f2f3f5; --accent:#7c9eff;
  --modal-bg:#02104f; --modal-media-bg:#030d3b; --overlay:rgba(0,0,0,.6);
  --modal-w:760px; --modal-info-w:300px; --modal-max-h:88vh;
}
*{box-sizing:border-box}
body{margin:0; font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; background:var(--bg); color:var(--fg)}
.wrap{max-width:1100px; margin:0 auto; padding:16px}

/* toolbar */
.toolbar{display:flex; align-items:center; gap:10px}
.search{flex:1 1 100%; min-width:0}
.search input{width:100%; padding:12px 14px; border:1px solid var(--control-bd); border-radius:12px; background:var(--control-bg); color:var(--control-fg); outline:none}
.search input:hover{background:var(--control-bg-hover)}
.search input:focus{outline:2px solid var(--accent); outline-offset:2px}
.select{margin-left:auto; flex:0 0 auto}
.select select{padding:10px 12px; border:1px solid var(--control-bd); border-radius:12px; background:var(--control-bg); color:var(--control-fg)}

/* grid */
.grid{display:grid; gap:var(--gap); grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); margin-top:16px}
.card{background:var(--panel); border:1px solid var(--bd); border-radius:var(--r); padding:8px; cursor:pointer; min-height:140px; display:flex; align-items:center; justify-content:center}
.card img{display:block; width:100%; height:auto; border-radius:calc(var(--r) - 6px)}
.card .ph{width:100%; aspect-ratio:1/1; border:1px dashed var(--bd); border-radius:calc(var(--r) - 6px); display:grid; place-items:center; color:var(--muted); font-size:12px; padding:8px; text-align:center}

.counter{display:none}
.err{margin-top:8px; color:#ffd8d8}

/* pagination controls */
.pager{
  display:flex; gap:8px; align-items:center; flex-wrap:wrap;
  justify-content:center; margin:14px 0;
}
.pager .pg{
  display:inline-flex; align-items:center; justify-content:center;
  min-width:36px; height:36px; padding:0 10px; border-radius:10px;
  border:1px solid var(--bd); background:var(--panel); color:var(--fg);
  font-weight:600; cursor:pointer; user-select:none;
}
.pager .pg[aria-current="page"]{
  outline:2px solid var(--accent); border-color:transparent;
}
.pager .pg[disabled]{ opacity:.45; cursor:not-allowed; }

/* ===== Modal (single, clean set — JS positions to visible viewport) ===== */
#modal[hidden]{ display:none; }

/* overlay — JS sets top/height so it covers only the visible window inside iframe */
#modal{
  position:absolute;
  left:0;
  width:100%;
  background:var(--overlay);
  display:block;
  z-index:9999;
}

/* modal box — JS centers this within the visible window */
#modal .modal-wrap{
  position:absolute;
  width:min(var(--modal-w), 92vw);
  max-height:var(--modal-max-h);
  display:grid;
  grid-template-columns:1fr var(--modal-info-w);
  border-radius:16px;
  overflow:hidden;
}

/* modal contents */
.modal-media{
  background:var(--modal-media-bg);
  display:flex; align-items:center; justify-content:center;
  padding:16px;
}
.modal-media img{
  max-width:100%;
  max-height:calc(var(--modal-max-h) - 32px);
  border-radius:12px;
  object-fit:contain;
}
.modal-info{
  background:var(--modal-bg);
  border-left:1px solid var(--bd);
  padding:12px;
  position:relative;
  padding-bottom:56px; /* room for nav buttons when anchored bottom-right */
}
.modal-title{font-weight:700; font-size:clamp(1.1rem, 2vw + .2rem, 1.8rem); line-height:1.2; margin-bottom:6px}
.navbtns{position:absolute; right:12px; bottom:12px; display:flex; gap:8px}
.navbtns button{padding:8px 10px; border:1px solid var(--control-bd); border-radius:10px; background:var(--control-bg); color:var(--control-fg); cursor:pointer}
.navbtns button[disabled]{opacity:.45; pointer-events:none}
.close{position:absolute; top:8px; right:8px; background:transparent; border:none; color:var(--fg); font-size:20px; cursor:pointer}

@media (max-width:720px){
  #modal .modal-wrap{ grid-template-columns:1fr; }
  .modal-info{ border-left:none; border-top:1px solid var(--bd); }
}

/* a11y */
.sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0}
html.is-modal-open{ overflow:hidden; }
</style>
</head>
<body>
  <div class="wrap">
    <div class="toolbar" role="search">
      <div class="search">
        <label class="sr-only" for="q">Search badges</label>
        <input id="q" type="search" placeholder="Search badges…" autocomplete="off" />
      </div>
      <div class="select">
        <label class="sr-only" for="sort">Sort</label>
        <select id="sort">
          <option value="name-asc">Name ↑</option>
          <option value="name-desc">Name ↓</option>
        </select>
      </div>
    </div>

    <div class="counter"><small id="count"></small></div>

    <nav id="pager-top" class="pager" aria-label="Badge navigation"></nav>
    <div id="err" class="err" role="status" aria-live="polite"></div>
    <nav id="pager-bottom" class="pager" aria-label="Badge navigation"></nav>

    
  </div>

  <div id="modal" role="dialog" aria-labelledby="modal-title" aria-modal="true" hidden>
    <div class="modal-wrap">
      <div class="modal-media">
        <img id="mimg" alt="">
      </div>
      <div class="modal-info">
        <button id="mclose" class="close" aria-label="Close">✕</button>
        <div id="modal-title" class="modal-title"></div>
        <div id="mcrit"></div>
        <div class="navbtns">
          <button id="prevBtn" aria-label="Previous">← Prev</button>
          <button id="nextBtn" aria-label="Next">Next →</button>
        </div>
      </div>
    </div>
  </div>

<script>
const grid   = document.getElementById('grid');
const q      = document.getElementById('q');
const sortEl = document.getElementById('sort');
const count  = document.getElementById('count');
const errEl  = document.getElementById('err');
const pagerT = document.getElementById('pager-top');
const pagerB = document.getElementById('pager-bottom');

const modal  = document.getElementById('modal');
const mimg   = document.getElementById('mimg');
const mtitle = document.getElementById('modal-title');
const mcrit  = document.getElementById('mcrit');
const mclose = document.getElementById('mclose');
const prevBtn= document.getElementById('prevBtn');
const nextBtn= document.getElementById('nextBtn');
const modalWrap = document.querySelector('#modal .modal-wrap');

let BADGES = [];
let CURRENT = [];
let currentIndex = -1;
let page = 1;
const PAGE_SIZE = 24;

const norm = s => (s||'').toLowerCase().normalize('NFKD').replace(/[\u0300-\u036f]/g,'');
const imageFrom = b => b.imageUrl ?? b.imageURL ?? b.url ?? b.image ?? b.src ?? '';

/* filtering and paging */
function apply(resetPage=true){
  const term = norm(q.value);
  const dir  = sortEl.value;

  CURRENT = BADGES.filter(b => {
    if (!term) return true;
    return norm(b.name).includes(term) || norm(b.criteria ?? '').includes(term);
  });

  CURRENT.sort((a,b)=>{
    const an = norm(a.name), bn = norm(b.name);
    return dir === 'name-desc' ? bn.localeCompare(an) : an.localeCompare(bn);
  });

  if (resetPage) page = 1;
  renderPage();
}

function renderPage(){
  const totalPages = Math.max(1, Math.ceil(CURRENT.length / PAGE_SIZE));
  page = Math.min(Math.max(1, page), totalPages);

  const start = (page - 1) * PAGE_SIZE;
  const slice = CURRENT.slice(start, start + PAGE_SIZE);

  render(slice);
  renderPager(pagerT, totalPages);
  renderPager(pagerB, totalPages);
  count.textContent = `${CURRENT.length} badges — page ${page}/${totalPages}`;
}

/* pager UI */
function renderPager(el, total){
  if (!el) return;
  if (total <= 1) { el.innerHTML = ''; return; }

  const btn = (label, disabled, curr=false, data='') =>
    `<button class="pg"${curr?' aria-current="page"':''}${disabled?' disabled':''}${data}>${label}</button>`;

  let html = btn('‹', page===1, false, ' data-nav="prev"');
  const windowPages = buildWindow(page,total);
  for (const p of windowPages){
    if (p === '…') html += `<span class="pg" style="pointer-events:none">…</span>`;
    else html += btn(p, false, p===page, ` data-page="${p}"`);
  }
  html += btn('›', page===total, false, ' data-nav="next"');
  el.innerHTML = html;

  el.onclick = e=>{
    const b = e.target.closest('.pg');
    if (!b || b.disabled) return;
    if (b.dataset.page) goToPage(parseInt(b.dataset.page,10));
    else if (b.dataset.nav==='prev') goToPage(page-1);
    else if (b.dataset.nav==='next') goToPage(page+1);
  };
}

function buildWindow(page,total){
  const s = new Set([1,total,page,page-1,page+1]);
  const arr = [...s].filter(n=>n>=1&&n<=total).sort((a,b)=>a-b);
  const out=[];
  for(let i=0;i<arr.length;i++){
    out.push(arr[i]);
    if(i<arr.length-1 && arr[i+1]-arr[i]>1) out.push('…');
  }
  return out;
}

function goToPage(n){
  page=n;
  renderPage();
  grid.scrollIntoView({behavior:'smooth',block:'start'});
}

/* render cards (same as before) */
function render(list){
  grid.innerHTML='';
  const frag=document.createDocumentFragment();
  list.forEach((b,i)=>{
    const card=document.createElement('button');
    card.className='card';
    card.type='button';
    card.setAttribute('aria-label',b.name);
    card.addEventListener('mousedown',e=>e.preventDefault());
    card.addEventListener('touchstart',e=>{e.preventDefault();},{passive:false});
    card.addEventListener('click',()=>openModalByIndex((page-1)*PAGE_SIZE+i));
    const img=document.createElement('img');
    img.loading='lazy'; img.alt=b.name; img.src=imageFrom(b);
    img.referrerPolicy='no-referrer';
    img.onerror=()=>{
      img.remove();
      const ph=document.createElement('div'); ph.className='ph'; ph.textContent='Image failed to load';
      card.appendChild(ph);
    };
    card.appendChild(img);
    frag.appendChild(card);
  });
  grid.appendChild(frag);
}

/* modal logic (unchanged from your file) */
function updateNavButtons(){ prevBtn.disabled=currentIndex<=0; nextBtn.disabled=currentIndex>=CURRENT.length-1; }
function preload(i){ if(i<0||i>=CURRENT.length)return; const im=new Image(); im.referrerPolicy='no-referrer'; im.src=imageFrom(CURRENT[i]); }
function openModalByIndex(i){ if(i<0||i>=CURRENT.length)return;
  currentIndex=i; const b=CURRENT[i];
  mimg.src=imageFrom(b); mimg.alt=b.name||''; mtitle.textContent=b.name||''; mcrit.textContent=b.criteria||'';
  modalOpen(); updateNavButtons(); preload(i-1); preload(i+1); }
function closeModal(){ modalClose(); currentIndex=-1; }

/* overlay positioning (your existing logic) */
function positionOverlay(){
  const y=window.scrollY||document.documentElement.scrollTop||0;
  const h=window.innerHeight||document.documentElement.clientHeight||0;
  modal.style.top=y+'px'; modal.style.height=h+'px';
  const boxH=Math.min(modalWrap.offsetHeight||0,Math.max(240,h*0.92));
  const top=y+Math.max(12,(h-boxH)/2);
  modalWrap.style.top=Math.round(top)+'px';
  modalWrap.style.left='50%';
  modalWrap.style.transform='translateX(-50%)';
}
let overlayBound=false;
function bindOverlayPositioning(){
  if(overlayBound)return; overlayBound=true; positionOverlay();
  window.addEventListener('scroll',positionOverlay,{passive:true});
  window.addEventListener('resize',positionOverlay);
  setTimeout(positionOverlay,50); setTimeout(positionOverlay,200);
}
function unbindOverlayPositioning(){
  if(!overlayBound)return; overlayBound=false;
  window.removeEventListener('scroll',positionOverlay);
  window.removeEventListener('resize',positionOverlay);
  ['top','height'].forEach(k=>modal.style[k]='');
  ['top','left','transform'].forEach(k=>modalWrap.style[k]='');
}
function modalIsOpen(){return !modal.hasAttribute('hidden');}
function modalOpen(){ if(!modalIsOpen()){ modal.removeAttribute('hidden'); document.documentElement.classList.add('is-modal-open'); bindOverlayPositioning(); } }
function modalClose(){ if(modalIsOpen()){ modal.setAttribute('hidden',''); document.documentElement.classList.remove('is-modal-open'); unbindOverlayPositioning(); } }

/* events */
q.addEventListener('input',()=>apply(true));
sortEl.addEventListener('change',()=>apply(true));
mclose.addEventListener('mousedown',e=>e.preventDefault());
mclose.addEventListener('click',closeModal);
modal.addEventListener('click',e=>{if(e.target===modal)closeModal();});
prevBtn.addEventListener('click',e=>{e.preventDefault();if(currentIndex>0)openModalByIndex(currentIndex-1);});
nextBtn.addEventListener('click',e=>{e.preventDefault();if(currentIndex<CURRENT.length-1)openModalByIndex(currentIndex+1);});
document.addEventListener('keydown',e=>{
  if(!modalIsOpen())return;
  if(e.key==='ArrowLeft'&&currentIndex>0)openModalByIndex(currentIndex-1);
  else if(e.key==='ArrowRight'&&currentIndex<CURRENT.length-1)openModalByIndex(currentIndex+1);
  else if(e.key==='Escape')closeModal();
});

/* data loader */
(async()=>{
  const base=location.pathname.replace(/[^/]+$/,'');
  const tried=['badges.json',base+'badges.json'];
  let data=null,lastErr=null;
  for(const url of tried){
    try{const r=await fetch(url,{cache:'no-store'});
      if(!r.ok)throw new Error('HTTP '+r.status+' for '+url);
      data=await r.json(); break;
    }catch(e){lastErr=e;}
  }
  if(!Array.isArray(data)||data.length===0){
    const msg=lastErr?`Could not load badges.json (${lastErr.message}).`:`Loaded 0 items from badges.json.`;
    if(errEl)errEl.textContent=msg; return;
  }
  BADGES=data.map(b=>({id:b.id??b.slug??'',name:b.name??'Untitled',imageUrl:imageFrom(b),criteria:b.criteria??''}));
  apply(true);
})();
</script>

</body>
</html>
